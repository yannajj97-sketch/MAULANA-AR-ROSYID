const express = require("express");
const bcrypt = require("bcryptjs");
const jwt = require("jsonwebtoken");
const bodyParser = require("body-parser");

const app = express();
app.use(bodyParser.json());
app.use(bodyParser.urlencoded({ extended: true }));

const SECRET = "UNICORN_SUPER_SECRET_KEY";

/* DATABASE SEMENTARA (Memory) */
let users = [];

/* AUTO CREATE ADMIN */
(async () => {
  const hash = await bcrypt.hash("admin123", 10);
  users.push({ id: 1, username: "maul", password: hash, role: "admin" });
})();

/* REGISTER */
app.post("/api/register", async (req, res) => {
  const { username, password, role } = req.body;
  const hash = await bcrypt.hash(password, 10);
  users.push({
    id: users.length + 1,
    username,
    password: hash,
    role: role || "investor",
  });
  res.json({ message: "User registered" });
});

/* LOGIN */
app.post("/api/login", async (req, res) => {
  const { username, password } = req.body;
  const user = users.find((u) => u.username === username);
  if (!user) return res.status(400).json({ msg: "User not found" });

  const valid = await bcrypt.compare(password, user.password);
  if (!valid) return res.status(400).json({ msg: "Wrong password" });

  const token = jwt.sign({ id: user.id, role: user.role }, SECRET, {
    expiresIn: "1h",
  });

  res.json({ token });
});

/* MIDDLEWARE AUTH */
function verifyToken(req, res, next) {
  const token = req.headers.authorization;
  if (!token) return res.status(403).json({ msg: "No token provided" });

  jwt.verify(token, SECRET, (err, decoded) => {
    if (err) return res.status(401).json({ msg: "Invalid token" });
    req.user = decoded;
    next();
  });
}

/* DASHBOARD API */
app.get("/api/dashboard", verifyToken, (req, res) => {
  res.json({
    message: "Welcome to Tech Unicorn Dashboard",
    role: req.user.role,
  });
});

/* FRONTEND PAGE */
app.get("/", (req, res) => {
  res.send(`
<!DOCTYPE html>
<html>
<head>
<title>GRUB MAUL LING - Tech Unicorn</title>
<style>
body{
  margin:0;
  font-family:Arial;
  background:black;
  color:gold;
  text-align:center;
}
.container{
  margin-top:100px;
}
input{
  padding:10px;
  margin:5px;
}
button{
  padding:10px 20px;
  background:gold;
  border:none;
  cursor:pointer;
}
.card{
  margin-top:30px;
  padding:20px;
  background:#111;
  display:inline-block;
  border-radius:10px;
}
</style>
</head>
<body>
<h1>GRUB MAUL LING - TECH UNICORN</h1>

<div class="container">
<input id="username" placeholder="Username"><br>
<input id="password" type="password" placeholder="Password"><br>
<button onclick="login()">Login</button>
<button onclick="register()">Register</button>

<div class="card" id="result"></div>
</div>

<script>
let token="";

async function login(){
 const username=document.getElementById("username").value;
 const password=document.getElementById("password").value;

 const res=await fetch("/api/login",{
   method:"POST",
   headers:{"Content-Type":"application/json"},
   body:JSON.stringify({username,password})
 });

 const data=await res.json();
 if(data.token){
   token=data.token;
   document.getElementById("result").innerHTML="Login Success";
 } else {
   document.getElementById("result").innerHTML=data.msg;
 }
}

async function register(){
 const username=document.getElementById("username").value;
 const password=document.getElementById("password").value;

 const res=await fetch("/api/register",{
   method:"POST",
   headers:{"Content-Type":"application/json"},
   body:JSON.stringify({username,password,role:"investor"})
 });

 const data=await res.json();
 document.getElementById("result").innerHTML=data.message;
}

async function dashboard(){
 const res=await fetch("/api/dashboard",{
   headers:{Authorization:token}
 });
 const data=await res.json();
 document.getElementById("result").innerHTML=data.message + " | Role: " + data.role;
}
</script>

<br><button onclick="dashboard()">Open Dashboard</button>

</body>
</html>
`);
});

app.listen(5000, () =>
  console.log("ðŸš€ Tech Unicorn running on http://localhost:5000")
);
